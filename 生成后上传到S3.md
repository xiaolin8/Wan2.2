生成视频后，我们希望将结果保存到对象存储中，这是一个非常常见的需求，即将计算结果持久化到对象存储中。

要实现这个功能，最优化的方法是**在 `generate.py` 脚本中集成上传逻辑**，而不是通过外部的 shell 脚本。这样做更健壮、更可靠。我们将使用 AWS 官方的 Python SDK `boto3` 来完成这个任务。

整个优化分为四个步骤：

### 第 1 步：环境准备

为了让我们的 Python 脚本能和 S3 通信，您需要确保两件事：

1.  **安装 `boto3` 库**:
    您的容器镜像中需要包含 `boto3` 这个 Python 库。我们已经通过将 `boto3` 添加到 `requirements.txt` 文件中完成了这一步。

2.  **提供 AWS 访问凭证**:
    为了安全，我们**绝对不能**将 AWS 的 Access Key 和 Secret Key 硬编码在代码或 YAML 文件里。在 Kubernetes 中，最安全、最标准的做法是使用 `Secret` 对象。`boto3` 会自动识别并使用名为 `AWS_ACCESS_KEY_ID` 和 `AWS_SECRET_ACCESS_KEY` 的环境变量。

### 第 2 步：修改 `generate.py` 脚本

我们已经修改了 `generate.py` 脚本，在视频成功保存到本地后，自动将其上传到 S3。具体修改包括：

1.  **添加新的命令行参数**:
    *   `--s3-bucket`: 用于指定您想上传到的 S3 存储桶的名称。
    *   `--s3-endpoint-url`: 用于指定 S3 兼容存储的端点 URL。
    *   `--s3-key-prefix`: 用于为上传的对象名称添加前缀。
2.  **添加上传函数**:
    *   在脚本中加入一个 `upload_to_s3` 函数，它会使用 `boto3` 库来执行上传操作。
3.  **调用上传函数**:
    *   在 `generate` 函数的末尾，视频成功保存后，调用这个上传函数。

### 第 3 步：准备 PyTorchJob YAML 文件

我们已经基于 `wan22-pytorchjob2.yaml` 创建了一个新的作业文件 `wan22-pytorchjob2-s3.yaml`。该文件已经配置好了运行 S3 上传所需的所有参数和环境变量。

### 第 4 步：在 Kubernetes 中运行（完整示例）

现在，您可以按照以下步骤在 Kubernetes 中运行一个完整的、能自动上传结果到 `play.min.io` 的任务。

**1. 创建 Kubernetes Secret**

首先，您需要在您的集群中创建一个 Secret 来存放 `play.min.io` 的访问凭证。我们的 `generate.py` 脚本和 PyTorchJob YAML 文件都配置为从这个 Secret 中读取凭证。

将以下内容保存为 `aws-credentials-secret.yaml` 文件：

```yaml
# aws-credentials-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: aws-credentials
type: Opaque
stringData:
  AWS_ACCESS_KEY_ID: "Q3AM3UQ867SPQQA43P2F"
  AWS_SECRET_ACCESS_KEY: "zuf+tfteSlswRu7BJ86wekitnifILbZam1KYY3TG"
```

然后，在您的终端中执行 `kubectl apply` 命令来创建这个 Secret：

```bash
kubectl apply -f aws-credentials-secret.yaml
```

**2. 查看并运行 PyTorchJob**

我们已经为您生成了 `wan22-pytorchjob2-s3.yaml` 文件。它包含了指向 S3 的参数和对上面创建的 Secret 的引用。

文件内容如下：

```yaml
apiVersion: "kubeflow.org/v1"
kind: PyTorchJob
metadata:
  name: wan22-t2v-distributed2-s3
spec:
  runPolicy:
    cleanPodPolicy: None # 可选值: All, Running, None. All 表示任务结束后清理所有 Pod
  pytorchReplicaSpecs:
    Master:
      replicas: 1
      restartPolicy: OnFailure
      template:
        spec:
          containers:
            - name: pytorch
              image: 172.31.0.182/system_containers/wan22:pytorch
              imagePullPolicy: Always
              command:
                - "torchrun"
              args:
                - "--nproc_per_node=2"
                - "generate.py"
                - "--task"
                - "t2v-A14B"
                - "--size"
                - "832*480"
                - "--ckpt_dir"
                - "/data/Wan2.2-T2V-A14B"
                - "--dit_fsdp"
                - "--t5_fsdp"
                - "--convert_model_dtype"
                - "--ulysses_size"
                - "4"
                - "--sample_guide_scale"
                - "10"
                - "--prompt"
                - "A cinematic video. An astronaut in a white spacesuit walks cautiously on the red, dusty surface of Mars. The camera follows the astronaut from behind in a tracking shot. The astronaut stops and looks up in surprise at a giant, dark rock. The camera tilts up to reveal the word \"tenxcloud\" clearly engraved on the rock's surface. The scene is realistic, with a desolate Martian landscape and a faint sun in the background, creating a sense of mystery and discovery."
                - "--save_file"
                - "/output/wan22-t2v-distributed2-rdma.mp4"
                - "--s3-endpoint-url"
                - "https://play.min.io"
                - "--s3-bucket"
                - "wan22"
                - "--s3-key-prefix"
                - "k8s-job-output"
              resources:
                requests:
                  cpu: "4"
                limits:
                  cpu: "16"
                  memory: 256Gi
                  nvidia.com/gpu: "2"
                  t7d.com/rdma: "1"
              env:
                - name: NVIDIA_VISIBLE_DEVICES
                  value: "all"
                - name: NCCL_DEBUG
                  value: "INFO"
              envFrom:
                - secretRef:
                    name: aws-credentials
              volumeMounts:
                - name: data-volume
                  mountPath: /data/Wan2.2-T2V-A14B
                - name: output-volume
                  mountPath: /output
                - name: dshm
                  mountPath: /dev/shm
          volumes:
            - name: data-volume
              hostPath:
                path: /data/Wan-AI/Wan2.2-T2V-A14B
            - name: output-volume
              hostPath:
                path: /data/Wan-AI/output
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: 2Gi
    Worker:
      replicas: 1
      restartPolicy: OnFailure
      template:
        spec:
          containers:
            - name: pytorch
              image: 172.31.0.182/system_containers/wan22:pytorch
              imagePullPolicy: Always
              command:
                - "torchrun"
              args:
                - "--nproc_per_node=2"
                - "generate.py"
                - "--task"
                - "t2v-A14B"
                - "--size"
                - "832*480"
                - "--ckpt_dir"
                - "/data/Wan2.2-T2V-A14B"
                - "--dit_fsdp"
                - "--t5_fsdp"
                - "--convert_model_dtype"
                - "--ulysses_size"
                - "4"
                - "--sample_guide_scale"
                - "10"
                - "--prompt"
                - "A cinematic video. An astronaut in a white spacesuit walks cautiously on the red, dusty surface of Mars. The camera follows the astronaut from behind in a tracking shot. The astronaut stops and looks up in surprise at a giant, dark rock. The camera tilts up to reveal the word \"tenxcloud\" clearly engraved on the rock's surface. The scene is realistic, with a desolate Martian landscape and a faint sun in the background, creating a sense of mystery and discovery."
                - "--save_file"
                - "/output/wan22-t2v-distributed2-rdma.mp4"
                - "--s3-endpoint-url"
                - "https://play.min.io"
                - "--s3-bucket"
                - "wan22"
                - "--s3-key-prefix"
                - "k8s-job-output"
              resources:
                requests:
                  cpu: "4"
                limits:
                  cpu: "16"
                  memory: 256Gi
                  nvidia.com/gpu: "2"
                  t7d.com/rdma: "1"
              env:
                - name: NVIDIA_VISIBLE_DEVICES
                  value: "all"
                - name: NCCL_DEBUG
                  value: "INFO"
              envFrom:
                - secretRef:
                    name: aws-credentials
              volumeMounts:
                - name: data-volume
                  mountPath: /data/Wan2.2-T2V-A14B
                - name: output-volume
                  mountPath: /output
                - name: dshm
                  mountPath: /dev/shm
          volumes:
            - name: data-volume
              hostPath:
                path: /data/Wan-AI/Wan2.2-T2V-A14B
            - name: output-volume
              hostPath:
                path: /data/Wan-AI/output
            - name: dshm
              emptyDir:
                medium: Memory
                sizeLimit: 2Gi
```

**3. 部署 PyTorchJob**

最后，使用 `kubectl` 部署这个任务。任务完成后，生成的视频文件将自动上传到 `play.min.io` 的 `wan22` 存储桶中。

```bash
kubectl apply -f wan22-pytorchjob2-s3.yaml
```